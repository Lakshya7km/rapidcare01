<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Public Portal - RapidCare</title>
  <link rel="stylesheet" href="/css/styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script defer src="/js/client.js"></script>

  <style>
    /* Page-specific overrides */
    .hospital-card {
      display: flex;
      flex-direction: column;
      height: 100%;
      border-top: 4px solid var(--primary-color);
    }

    .hospital-card .card-body {
      flex: 1;
    }

    .hospital-card .card-actions {
      margin-top: var(--spacing-md);
      display: flex;
      gap: var(--spacing-sm);
      flex-wrap: wrap;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.35rem 0.75rem;
      border-radius: 2rem;
      font-size: 0.85rem;
      font-weight: 600;
      gap: 0.25rem;
    }

    .status-available {
      background: #d1e7dd;
      color: #0f5132;
    }

    .status-busy {
      background: #fff3cd;
      color: #856404;
    }

    .status-full {
      background: #f8d7da;
      color: #842029;
    }

    .doctor-list-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      padding: var(--spacing-sm) 0;
      border-bottom: 1px solid var(--border-color);
    }

    .doctor-list-item:last-child {
      border-bottom: none;
    }

    .doctor-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #e9ecef;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }

    .hero-small {
      background: linear-gradient(135deg, var(--primary-color), #6610f2);
      color: white;
      padding: 3rem 0;
      text-align: center;
      margin-bottom: 2rem;
      border-radius: 0 0 1rem 1rem;
    }
  </style>
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="container nav-container">
      <div class="flex items-center gap-sm">
        <a href="/" class="flex items-center gap-sm" style="text-decoration: none;">
          <img src="/images/logo.png" alt="RapidCare Logo" class="logo">
          <span style="font-size: 1.5rem; font-weight: 700; color: var(--primary-color);">RapidCare</span>
        </a>
      </div>
      <div>
        <a href="/" class="btn btn-outline btn-sm">Home</a>
      </div>
    </div>
  </nav>

  <div class="hero-small">
    <div class="container">
      <h1>Find Medical Care</h1>
      <p class="mb-0" style="opacity: 0.9;">Locate nearby hospitals, check bed availability, and request emergency
        services.</p>
    </div>
  </div>



  <div class="container mt-4 mb-5">
    <!-- Hospitals Section -->
    <div id="section-hospitals" class="portal-section animate-fade-in">
      <div class="flex justify-between items-center mb-3">
        <h2>Nearby Hospitals</h2>
        <div style="width: 100%; max-width: 400px;">
          <input id="q" class="form-control" placeholder="üîç Search by name, city, or service..."
            oninput="filterHospitals()" />
        </div>
      </div>

      <div id="list" class="grid grid-auto-fit gap-md">
        <!-- Hospital cards will be injected here -->
        <div class="text-center text-muted" style="grid-column: 1/-1; padding: 2rem;">
          <div class="spinner-border text-primary" role="status"></div>
          <p class="mt-2">Loading hospitals...</p>
        </div>
      </div>
    </div>

    <!-- Emergency Request Section -->
    <div id="section-emergency-request" class="portal-section animate-fade-in" style="display: none;">
      <div class="flex justify-between items-center mb-3">
        <h2>Emergency Request</h2>
        <button class="btn btn-outline" onclick="showSection('hospitals')">‚Üê Back to Hospitals</button>
      </div>

      <div class="card" style="max-width: 800px; margin: 0 auto; border-top: 4px solid var(--danger-color);">
        <div class="card-header bg-light">
          <div class="flex items-center gap-md">
            <img src="/images/emergency.png" alt="Emergency" style="width: 48px; height: 48px;">
            <div>
              <h3 class="text-danger mb-0">Submit Emergency Alert</h3>
              <p class="text-muted mb-0 text-sm">Fill out the details below to alert nearby hospitals immediately.</p>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-md mt-3">
          <div class="form-group">
            <label class="form-label">Patient Name</label>
            <input id="emergency-patient-name" class="form-control" placeholder="Full Name" />
          </div>
          <div class="form-group">
            <label class="form-label">Age</label>
            <input id="emergency-patient-age" type="number" class="form-control" placeholder="Age" />
          </div>
          <div class="form-group">
            <label class="form-label">Gender</label>
            <select id="emergency-patient-gender" class="form-control">
              <option value="">Select Gender</option>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Emergency Type</label>
            <select id="emergency-type" class="form-control">
              <option value="">Select Type</option>
              <option value="Cardiac">Cardiac (Heart)</option>
              <option value="Trauma">Trauma / Accident</option>
              <option value="Respiratory">Respiratory (Breathing)</option>
              <option value="Neurological">Neurological (Brain)</option>
              <option value="General">General Emergency</option>
            </select>
          </div>
          <div class="form-group" style="grid-column: 1/-1;">
            <label class="form-label">Symptoms / Condition</label>
            <textarea id="emergency-symptoms" class="form-control" rows="2"
              placeholder="Describe the condition briefly..."></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Contact Number</label>
            <input id="emergency-contact" class="form-control" placeholder="Mobile Number" />
          </div>
          <div class="form-group">
            <label class="form-label">Preferred Hospital</label>
            <select id="emergency-hospital" class="form-control">
              <option value="">Nearest Available (Recommended)</option>
            </select>
          </div>
          <div class="form-group" style="grid-column: 1/-1;">
            <label class="form-label">Current Location / Address</label>
            <textarea id="emergency-address" class="form-control" rows="2"
              placeholder="Enter current location..."></textarea>
          </div>
        </div>

        <div class="mt-4">
          <button onclick="submitPublicEmergency()" class="btn btn-danger btn-block"
            style="padding: 1rem; font-size: 1.1rem;">
            üö® Send Emergency Alert
          </button>
        </div>

        <div id="emergency-response" class="mt-4"></div>
      </div>
    </div>
  </div>

  <script>
    let allHospitals = [];

    document.addEventListener('DOMContentLoaded', function () {
      loadAllHospitals();
      setupRealTimeListeners();
    });

    function showSection(sectionName) {
      document.querySelectorAll('.portal-section').forEach(el => el.style.display = 'none');
      const target = document.getElementById('section-' + sectionName);
      if (target) target.style.display = 'block';

      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });

      if (sectionName === 'emergency-request') loadEmergencyForm();
    }

    async function loadAllHospitals() {
      try {
        const hospitals = await api('/api/hospital');
        allHospitals = hospitals;
        displayHospitals(hospitals);
      } catch (e) {
        console.error('Error loading hospitals:', e);
        document.getElementById('list').innerHTML = `
          <div class="alert alert-danger" style="grid-column: 1/-1;">
            Failed to load hospitals. Please check your connection.
          </div>`;
      }
    }

    function filterHospitals() {
      const q = (document.getElementById('q').value || '').toLowerCase();
      if (!q) { displayHospitals(allHospitals); return; }

      const filter = (s) => (s || '').toLowerCase().includes(q);
      const filtered = allHospitals.filter(h =>
        filter(h.name) ||
        filter(h.hospitalId) ||
        filter(h.address?.city) ||
        (h.services || []).some(filter)
      );
      displayHospitals(filtered);
    }

    function displayHospitals(hospitals) {
      const container = document.getElementById('list');
      container.innerHTML = '';

      if (hospitals.length === 0) {
        container.innerHTML = '<div class="text-muted text-center" style="grid-column: 1/-1; padding: 2rem;">No hospitals found matching your search.</div>';
        return;
      }

      hospitals.forEach(h => {
        const el = document.createElement('div');
        el.className = 'card hospital-card';

        el.innerHTML = `
          <div class="card-body">
            <div class="flex justify-between items-center mb-2">
              <h3 class="text-primary mb-0" style="font-size: 1.25rem;">${h.name || h.hospitalId}</h3>
              <img src="/images/hospital.png" alt="Icon" style="width: 24px; height: 24px; opacity: 0.5;">
            </div>
            <p class="text-muted" style="font-size: 0.9rem;">
              üìç ${h.address?.city || 'City'}, ${h.address?.state || 'State'}
            </p>
            
            <div class="mb-3">
              <div id="bed-${h.hospitalId}" class="status-badge status-busy">
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Checking beds...
              </div>
            </div>

            <div style="font-size: 0.9rem;" class="mb-3">
              <strong>Services:</strong>
              <span class="text-muted">${(h.services || []).slice(0, 3).join(', ') || 'General'}</span>
            </div>
            
            <div id="doc-${h.hospitalId}" class="mt-3 pt-3 border-top">
              <small class="text-muted">Loading doctors...</small>
            </div>
          </div>
          
          <div class="card-actions">
            <button class="btn btn-outline btn-sm" style="flex:1;" onclick="callHospital('${h.contact}')">üìû Call</button>
            <button class="btn btn-outline btn-sm" style="flex:1;" onclick="viewOnMap('${h.googleMapUrl}', '${h.name}')">üó∫Ô∏è Map</button>
            <button class="btn btn-danger btn-sm" style="flex:1;" onclick="openEmergency('${h.hospitalId}')">üö® Emergency</button>
          </div>
        `;

        container.appendChild(el);
        loadBedCount(h.hospitalId);
        loadDoctors(h.hospitalId);
      });
    }

    async function loadBedCount(hospitalId) {
      try {
        const beds = await api(`/api/beds/${hospitalId}`);
        const total = beds.length;
        const occupied = beds.filter(b => b.status === 'Occupied').length;
        const vacant = total - occupied;

        const el = document.getElementById(`bed-${hospitalId}`);
        if (el) {
          if (vacant > 0) {
            el.innerHTML = `üü¢ ${vacant} Beds Available`;
            el.className = 'status-badge status-available';
          } else {
            el.innerHTML = `üî¥ Full`;
            el.className = 'status-badge status-full';
          }
        }
      } catch (e) {
        const el = document.getElementById(`bed-${hospitalId}`);
        if (el) el.innerText = 'Beds info unavailable';
      }
    }

    async function loadDoctors(hospitalId) {
      try {
        const list = await api(`/api/doctors/${hospitalId}`);
        const availableDocs = list.filter(d => d.availability === 'Available').slice(0, 2);

        const el = document.getElementById(`doc-${hospitalId}`);
        if (el) {
          if (availableDocs.length > 0) {
            el.innerHTML = availableDocs.map(d => `
              <div class="doctor-list-item">
                <div class="doctor-avatar">üë®‚Äç‚öïÔ∏è</div>
                <div style="line-height: 1.2;">
                  <div style="font-weight: 600; font-size: 0.9rem;">${d.name}</div>
                  <div style="font-size: 0.8rem;" class="text-muted">${d.speciality}</div>
                </div>
              </div>
            `).join('') + (list.length > 2 ? `<div class="text-center mt-1"><small class="text-primary">+${list.length - 2} more</small></div>` : '');
          } else {
            el.innerHTML = '<small class="text-muted">No doctors currently available</small>';
          }
        }
      } catch (e) {
        const el = document.getElementById(`doc-${hospitalId}`);
        if (el) el.innerHTML = '<small class="text-muted">Doctor info unavailable</small>';
      }
    }

    function callHospital(contact) {
      if (!contact || contact === 'undefined') return alert('Contact number not available');
      alert(`Calling ${contact}...`);
    }

    function viewOnMap(url, name) {
      if (url && url.startsWith('http')) {
        window.open(url, '_blank');
      } else {
        window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name + ' hospital')}`, '_blank');
      }
    }

    function openEmergency(hospitalId) {
      showSection('emergency-request');
      setTimeout(() => {
        const select = document.getElementById('emergency-hospital');
        if (select) select.value = hospitalId;
        document.getElementById('emergency-patient-name').focus();
      }, 100);
    }

    function loadEmergencyForm() {
      const select = document.getElementById('emergency-hospital');
      const currentVal = select.value;
      select.innerHTML = '<option value="">Nearest Available (Recommended)</option>';
      allHospitals.forEach(h => {
        const opt = document.createElement('option');
        opt.value = h.hospitalId;
        opt.textContent = h.name;
        select.appendChild(opt);
      });
      if (currentVal) select.value = currentVal;
    }

    async function submitPublicEmergency() {
      const name = document.getElementById('emergency-patient-name').value.trim();
      const type = document.getElementById('emergency-type').value;
      const contact = document.getElementById('emergency-contact').value.trim();

      if (!name || !type || !contact) {
        alert('Please fill in Patient Name, Emergency Type, and Contact Number.');
        return;
      }

      const hospitalId = document.getElementById('emergency-hospital').value || (allHospitals[0]?.hospitalId);
      if (!hospitalId) return alert('No hospitals available.');

      const payload = {
        hospitalId,
        patient: {
          name,
          age: document.getElementById('emergency-patient-age').value,
          gender: document.getElementById('emergency-patient-gender').value,
          symptoms: document.getElementById('emergency-symptoms').value,
          emergencyType: type,
          contactMobile: contact,
          contactAddress: document.getElementById('emergency-address').value
        },
        status: 'Pending'
      };

      const respDiv = document.getElementById('emergency-response');
      respDiv.innerHTML = '<div class="alert alert-warning">‚è≥ Sending emergency alert...</div>';

      try {
        const res = await fetch('/api/emergency/public', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (res.ok) {
          const data = await res.json();
          respDiv.innerHTML = `
            <div class="alert alert-success">
              <h4>‚úÖ Alert Sent!</h4>
              <p>Request ID: <strong>${data.emergency._id}</strong></p>
              <p>Status: <span class="status-badge status-busy">PENDING</span></p>
              <p class="mb-0">Please wait. Hospital staff will contact you at <strong>${contact}</strong> shortly.</p>
            </div>
          `;
          startPolling(data.emergency._id);
        } else {
          throw new Error('Submission failed');
        }
      } catch (e) {
        respDiv.innerHTML = `<div class="alert alert-danger">‚ùå Error: ${e.message}</div>`;
      }
    }

    let pollInterval;
    function startPolling(id) {
      if (pollInterval) clearInterval(pollInterval);
      pollInterval = setInterval(async () => {
        try {
          const res = await api(`/api/emergency/detail/${id}`);
          if (res.success && res.emergency.status !== 'Pending') {
            clearInterval(pollInterval);
            const e = res.emergency;
            const color = e.status === 'Accepted' ? 'success' : 'danger';
            document.getElementById('emergency-response').innerHTML = `
              <div class="alert alert-${color}">
                <h4>${e.status === 'Accepted' ? '‚úÖ Ambulance Dispatched!' : '‚ùå Request Declined'}</h4>
                <p>Status: <strong>${e.status}</strong></p>
                ${e.rejectionReason ? `<p>Reason: ${e.rejectionReason}</p>` : ''}
              </div>
            `;
          }
        } catch (e) { }
      }, 3000);
    }

    function setupRealTimeListeners() {
      window.socket.on('bed:publicUpdate', p => loadBedCount(p.hospitalId));
      window.socket.on('doctor:publicUpdate', p => loadDoctors(p.hospitalId));
      window.socket.on('hospital:publicUpdate', () => loadAllHospitals());
    }
  </script>
</body>

</html>