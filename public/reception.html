<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reception Portal - RapidCare</title>
  <link rel="stylesheet" href="/css/styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script defer src="/js/client.js"></script>
  <script defer src="/js/reset-db.js"></script>
  <style>
    /* Dashboard Layout */
    .dashboard-container {
      display: flex;
      min-height: 100vh;
      background-color: var(--bg-body);
    }

    .sidebar {
      width: 280px;
      background-color: #fff;
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      z-index: 100;
      box-shadow: var(--shadow-sm);
    }

    .sidebar-header {
      padding: var(--spacing-lg);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .sidebar-nav {
      padding: var(--spacing-md);
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      padding: 0.75rem 1rem;
      border-radius: var(--border-radius);
      color: var(--text-muted);
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition-base);
    }

    .nav-item:hover {
      background-color: rgba(11, 110, 253, 0.05);
      color: var(--primary-color);
      text-decoration: none;
    }

    .nav-item.active {
      background-color: rgba(11, 110, 253, 0.1);
      color: var(--primary-color);
      font-weight: 600;
    }

    .main-content {
      flex: 1;
      margin-left: 280px;
      padding: var(--spacing-lg);
      max-width: 1600px;
    }

    /* Stats Cards */
    .stat-card {
      background: white;
      padding: var(--spacing-lg);
      border-radius: var(--border-radius-lg);
      border: 1px solid rgba(0, 0, 0, 0.05);
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      box-shadow: var(--shadow-sm);
      transition: var(--transition-base);
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .stat-icon {
      width: 56px;
      height: 56px;
      border-radius: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.75rem;
    }

    /* Tables */
    .table-container {
      overflow-x: auto;
      background: white;
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
      text-align: left;
    }

    th {
      background-color: var(--bg-body);
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
    }

    tr:last-child td {
      border-bottom: none;
    }

    /* Mobile Sidebar Toggle */
    .menu-toggle {
      display: none;
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 1000;
      background: white;
      border: 1px solid var(--border-color);
      padding: 0.5rem;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-sm);
    }

    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
        padding: var(--spacing-md);
      }

      .menu-toggle {
        display: block;
      }
    }
  </style>
</head>

<body>

  <!-- Login Section -->
  <div id="login-section" class="container"
    style="display: none; min-height: 100vh; display: flex; align-items: center; justify-content: center;">
    <div class="card glass" style="width: 100%; max-width: 400px; border-top: 4px solid var(--primary-color);">
      <div class="card-header text-center border-0 pb-0">
        <img src="/images/hospital.png" alt="Hospital" style="width: 64px; height: 64px; margin-bottom: 1rem;">
        <h3 class="text-primary">Reception Portal</h3>
        <p class="text-muted">Please login to manage hospital operations</p>
      </div>
      <div class="form-group">
        <label class="form-label">Hospital ID</label>
        <input id="login-hospitalId" class="form-control" placeholder="e.g., HOSP001" />
      </div>
      <div class="form-group">
        <label class="form-label">Password</label>
        <input id="login-password" type="password" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      </div>
      <button onclick="loginHospital()" class="btn btn-primary btn-block">Login</button>
      <div id="login-msg" class="alert alert-danger mt-3" style="display:none;"></div>
      <div class="text-center mt-3">
        <a href="/" class="text-sm text-muted">Back to Home</a>
      </div>
    </div>
  </div>

  <!-- Dashboard Layout -->
  <div id="dashboard-layout" class="dashboard-container" style="display: none;">

    <!-- Mobile Toggle -->
    <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <img src="/images/logo.png" alt="Logo" style="height: 32px;">
        <div>
          <h3 class="text-primary mb-0" style="font-size: 1.2rem;">RapidCare</h3>
          <small class="text-muted">Reception Panel</small>
        </div>
      </div>
      <nav class="sidebar-nav">
        <a class="nav-item active" onclick="showSection('dashboard')">
          <span>üìä</span> Dashboard
        </a>
        <a class="nav-item" onclick="showSection('hospital-info')">
          <span>üè•</span> Hospital Info
        </a>
        <a class="nav-item" onclick="showSection('beds')">
          <span>üõèÔ∏è</span> Bed Management
        </a>
        <a class="nav-item" onclick="showSection('doctors')">
          <span>üë®‚Äç‚öïÔ∏è</span> Doctors
        </a>
        <a class="nav-item" onclick="showSection('ambulances')">
          <span>üöë</span> Ambulances
        </a>
        <a class="nav-item" onclick="showSection('emergencies')">
          <span>üö®</span> Emergencies
        </a>
        <a class="nav-item" onclick="showSection('dbms')">
          <span>üóÑÔ∏è</span> Database View
        </a>
        <div style="margin-top: auto; border-top: 1px solid var(--border-color); padding-top: var(--spacing-md);">
          <a class="nav-item text-danger" onclick="logout()">
            <span>üö™</span> Logout
          </a>
        </div>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">

      <!-- Dashboard Overview -->
      <div id="section-dashboard" class="portal-section animate-fade-in">
        <h2 class="mb-3">Dashboard Overview</h2>
        <div class="grid grid-cols-3 grid-auto-fit gap-md mb-4">
          <div class="stat-card">
            <div class="stat-icon" style="background: #e7f1ff; color: #0b6efd;">üõèÔ∏è</div>
            <div>
              <div class="text-muted text-sm">Beds Available</div>
              <h3 class="mb-0" id="dash-beds">Loading...</h3>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon" style="background: #d1e7dd; color: #0f5132;">üë®‚Äç‚öïÔ∏è</div>
            <div>
              <div class="text-muted text-sm">Doctors On Duty</div>
              <h3 class="mb-0" id="dash-docs">Loading...</h3>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon" style="background: #fff3cd; color: #856404;">üöë</div>
            <div>
              <div class="text-muted text-sm">Ambulances Active</div>
              <h3 class="mb-0" id="dash-ambs">Loading...</h3>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header flex justify-between items-center border-0 pb-0">
            <h3 class="mb-0">Recent Emergency Requests</h3>
            <button class="btn btn-outline btn-sm" onclick="showSection('emergencies')">View All</button>
          </div>
          <div class="table-container mt-3 border-0">
            <table class="table">
              <thead>
                <tr>
                  <th>Patient</th>
                  <th>Type</th>
                  <th>Status</th>
                  <th>Time</th>
                </tr>
              </thead>
              <tbody id="dash-recent-emergencies">
                <tr>
                  <td colspan="4" class="text-center text-muted py-4">No recent emergencies</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Hospital Info -->
      <div id="section-hospital-info" class="portal-section animate-fade-in" style="display: none;">
        <div class="card">
          <div class="card-header flex justify-between items-center">
            <h3 class="mb-0">Hospital Profile</h3>
            <button class="btn btn-primary" onclick="saveHospital()">Save Changes</button>
          </div>

          <div class="grid grid-cols-2 gap-md mt-3">
            <div class="form-group">
              <label class="form-label">Hospital ID</label>
              <input id="h-id" class="form-control" disabled />
            </div>
            <div class="form-group">
              <label class="form-label">Hospital Name</label>
              <input id="h-name" class="form-control" />
            </div>
            <div class="form-group">
              <label class="form-label">Contact Number</label>
              <input id="h-contact" class="form-control" />
            </div>
            <div class="form-group">
              <label class="form-label">State</label>
              <input id="h-state" class="form-control" />
            </div>
            <div class="form-group">
              <label class="form-label">District</label>
              <input id="h-district" class="form-control" />
            </div>
            <div class="form-group">
              <label class="form-label">City</label>
              <input id="h-city" class="form-control" />
            </div>
            <div class="form-group" style="grid-column: 1/-1;">
              <label class="form-label">Street Address</label>
              <input id="h-street" class="form-control" />
            </div>

            <div class="form-group" style="grid-column: 1/-1;">
              <label class="form-label">Services (comma separated)</label>
              <input id="h-services" class="form-control" placeholder="Emergency, Cardiology, etc." />
            </div>

            <!-- Collapsible details -->
            <div style="grid-column: 1/-1;">
              <details class="bg-light rounded p-3">
                <summary class="cursor-pointer font-weight-bold text-primary">More Details (Facilities, Insurance, etc.)
                </summary>
                <div class="grid grid-cols-2 gap-md mt-3">
                  <div class="form-group"><label class="form-label">Tests</label><input id="h-tests"
                      class="form-control" /></div>
                  <div class="form-group"><label class="form-label">Insurance</label><input id="h-insurance"
                      class="form-control" /></div>
                  <div class="form-group"><label class="form-label">Procedures</label><input id="h-procedures"
                      class="form-control" /></div>
                  <div class="form-group"><label class="form-label">Facilities</label><input id="h-facilities"
                      class="form-control" /></div>
                  <div class="form-group"><label class="form-label">Management</label><input id="h-management"
                      class="form-control" /></div>
                  <div class="form-group"><label class="form-label">Highlights</label><input id="h-highlights"
                      class="form-control" /></div>
                  <div class="form-group"><label class="form-label">Treatment</label><input id="h-treatment"
                      class="form-control" /></div>
                  <div class="form-group"><label class="form-label">Surgery</label><input id="h-surgery"
                      class="form-control" /></div>
                  <div class="form-group"><label class="form-label">Therapy</label><input id="h-therapy"
                      class="form-control" /></div>
                </div>
              </details>
            </div>
          </div>
        </div>
      </div>

      <!-- Bed Management -->
      <div id="section-beds" class="portal-section animate-fade-in" style="display: none;">
        <div class="grid grid-cols-1 gap-md">
          <!-- Create Beds -->
          <div class="card">
            <div class="card-header">
              <h3 class="mb-0">Register New Beds</h3>
            </div>
            <div class="grid grid-cols-4 gap-sm items-end mt-3">
              <div class="form-group mb-0">
                <label class="form-label text-xs">Ward No.</label>
                <input id="ward" class="form-control" placeholder="e.g. A1" />
              </div>
              <div class="form-group mb-0">
                <label class="form-label text-xs">Type</label>
                <select id="bedType" class="form-control">
                  <option>General</option>
                  <option>ICU</option>
                  <option>Private</option>
                  <option>Emergency</option>
                </select>
              </div>
              <div class="form-group mb-0 flex gap-sm">
                <div>
                  <label class="form-label text-xs">Start #</label>
                  <input id="start" type="number" class="form-control" placeholder="1" />
                </div>
                <div>
                  <label class="form-label text-xs">End #</label>
                  <input id="end" type="number" class="form-control" placeholder="10" />
                </div>
              </div>
              <button onclick="createBeds()" class="btn btn-primary" style="height: 42px;">Create Beds</button>
            </div>
            <div id="beds-status" class="mt-2 text-success"></div>
          </div>

          <!-- Bed List -->
          <div class="card">
            <div class="card-header flex justify-between items-center flex-wrap gap-sm">
              <h3 class="mb-0">Bed Status</h3>
              <div class="flex gap-sm">
                <input id="bed-search" class="form-control" placeholder="Search bed..." style="width: 150px;" />
                <button onclick="searchBeds()" class="btn btn-outline">Search</button>
                <button onclick="printMassQR()" class="btn btn-success">Print All QR</button>
              </div>
            </div>
            <div id="bed-summary" class="alert alert-info mb-3 mt-3">Loading summary...</div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Type</th>
                    <th>Ward</th>
                    <th>Bed No.</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="beds"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Doctors Section -->
      <div id="section-doctors" class="portal-section animate-fade-in" style="display: none;">
        <div class="grid grid-cols-1 gap-md">
          <!-- Register Doctor -->
          <div class="card">
            <div class="card-header">
              <h3 class="mb-0">Register Doctor</h3>
            </div>
            <div class="grid grid-cols-3 gap-md mt-3">
              <div class="form-group"><label class="form-label">Doctor ID</label><input id="doc-id"
                  class="form-control" /></div>
              <div class="form-group"><label class="form-label">Name</label><input id="doc-name" class="form-control" />
              </div>
              <div class="form-group"><label class="form-label">Speciality</label><input id="doc-spec"
                  class="form-control" /></div>
              <div class="form-group"><label class="form-label">Qualification</label><input id="doc-qual"
                  class="form-control" /></div>
              <div class="form-group"><label class="form-label">Experience</label><input id="doc-exp"
                  class="form-control" /></div>
              <div class="form-group"><label class="form-label">Photo URL</label><input id="doc-photo"
                  class="form-control" /></div>
            </div>
            <button onclick="createDoctor()" class="btn btn-primary mt-2">Register Doctor</button>
          </div>

          <!-- Attendance QR -->
          <div class="card bg-light border-0">
            <div class="card-header flex justify-between items-center bg-transparent">
              <h4 class="mb-0">üîê Attendance QR Codes</h4>
              <div>
                <button onclick="generateHospitalQR()" id="gen-qr-btn" class="btn btn-sm btn-outline">Generate
                  QR</button>
                <button onclick="printHospitalQR()" id="print-qr-btn" class="btn btn-success btn-sm"
                  style="display:none;">Print PDF</button>
              </div>
            </div>
            <div id="qr-display" style="display:none;" class="text-center mt-3">
              <div class="flex justify-center gap-lg">
                <div class="text-center">
                  <img id="present-qr-img"
                    style="width:150px; height:150px; border:1px solid #ddd; background:white; padding: 10px; border-radius: 8px;" />
                  <p class="mt-2 font-bold text-success">CHECK IN</p>
                </div>
                <div class="text-center">
                  <img id="absent-qr-img"
                    style="width:150px; height:150px; border:1px solid #ddd; background:white; padding: 10px; border-radius: 8px;" />
                  <p class="mt-2 font-bold text-danger">CHECK OUT</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Doctor List -->
          <div class="card">
            <div class="card-header">
              <h3 class="mb-0">Doctor List & Attendance</h3>
            </div>
            <div id="doctors-list" class="grid grid-cols-2 gap-md mt-3"></div>
          </div>
        </div>
      </div>

      <!-- Ambulances Section -->
      <div id="section-ambulances" class="portal-section animate-fade-in" style="display: none;">
        <div class="grid grid-cols-1 gap-md">
          <div class="card">
            <div class="card-header">
              <h3 class="mb-0">Register Ambulance</h3>
            </div>
            <div class="grid grid-cols-3 gap-md mt-3">
              <div class="form-group"><label class="form-label">Ambulance ID</label><input id="amb-id"
                  class="form-control" /></div>
              <div class="form-group"><label class="form-label">Vehicle No.</label><input id="veh-num"
                  class="form-control" /></div>
              <div class="form-group"><label class="form-label">EMT Name</label><input id="amb-emt-name"
                  class="form-control" /></div>
              <div class="form-group"><label class="form-label">EMT Mobile</label><input id="amb-emt-mobile"
                  class="form-control" /></div>
              <div class="form-group"><label class="form-label">Pilot Name</label><input id="amb-pilot-name"
                  class="form-control" /></div>
              <div class="form-group"><label class="form-label">Pilot Mobile</label><input id="amb-pilot-mobile"
                  class="form-control" /></div>
            </div>
            <button onclick="createAmbulance()" class="btn btn-primary mt-2">Register Ambulance</button>
          </div>

          <div class="card">
            <div class="card-header">
              <h3 class="mb-0">Fleet Status</h3>
            </div>
            <div id="ambulances-cards" class="grid grid-cols-3 gap-md mt-3"></div>
          </div>
        </div>
      </div>

      <!-- Emergencies Section -->
      <div id="section-emergencies" class="portal-section animate-fade-in" style="display: none;">
        <div class="flex justify-between items-center mb-4">
          <h2>üö® Emergency Requests</h2>
          <div class="flex gap-sm">
            <button onclick="filterEmergencies('all')" class="btn btn-outline btn-sm active"
              id="filter-all">All</button>
            <button onclick="filterEmergencies('pending')" class="btn btn-outline btn-sm"
              id="filter-pending">Pending</button>
            <button onclick="filterEmergencies('accepted')" class="btn btn-outline btn-sm"
              id="filter-accepted">Accepted</button>
          </div>
        </div>

        <div id="emergency-stats" class="grid grid-cols-4 gap-md mb-4">
          <div class="card text-center py-3" style="border-left: 4px solid #ffc107;">
            <h3 id="pending-count" class="mb-0 text-warning">0</h3>
            <small class="text-muted">Pending</small>
          </div>
          <div class="card text-center py-3" style="border-left: 4px solid #198754;">
            <h3 id="accepted-count" class="mb-0 text-success">0</h3>
            <small class="text-muted">Accepted</small>
          </div>
          <div class="card text-center py-3" style="border-left: 4px solid #dc3545;">
            <h3 id="rejected-count" class="mb-0 text-danger">0</h3>
            <small class="text-muted">Rejected</small>
          </div>
          <div class="card text-center py-3" style="border-left: 4px solid #0dcaf0;">
            <h3 id="transferred-count" class="mb-0 text-info">0</h3>
            <small class="text-muted">Transferred</small>
          </div>
        </div>

        <div id="emergencies-cards" class="grid grid-cols-1 gap-md"></div>
      </div>

      <!-- DBMS Section -->
      <div id="section-dbms" class="portal-section animate-fade-in" style="display: none;">
        <div class="card">
          <div class="card-header">
            <h3 class="mb-0">Database View</h3>
            <p class="text-muted mb-0">Direct access to hospital data tables.</p>
          </div>
          <div class="grid grid-cols-1 gap-md mt-3">
            <details class="card border" style="padding: 0;">
              <summary class="card-header cursor-pointer hover:bg-light font-weight-bold">üè• Hospital Data</summary>
              <div id="dbms-hospital" class="p-3 bg-light" style="overflow-x: auto;">
                <div id="hospital-data-view"></div>
              </div>
            </details>
            <details class="card border" style="padding: 0;">
              <summary class="card-header cursor-pointer hover:bg-light font-weight-bold">üë®‚Äç‚öïÔ∏è Doctors Data</summary>
              <div id="dbms-doctors" class="p-3 bg-light" style="overflow-x: auto;">
                <div id="doctors-data-view"></div>
              </div>
            </details>
            <details class="card border" style="padding: 0;">
              <summary class="card-header cursor-pointer hover:bg-light font-weight-bold">üõèÔ∏è Beds Data</summary>
              <div id="dbms-beds" class="p-3 bg-light" style="overflow-x: auto;">
                <div id="beds-data-view"></div>
              </div>
            </details>
          </div>
        </div>
      </div>

    </main>
  </div>

  <script>
    let currentHospitalId = '';
    let currentUser = null;
    let allEmergencies = [];

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', function () {
      const role = localStorage.getItem('role');
      const hospitalId = localStorage.getItem('hospitalId');
      const token = getToken();

      if (role === 'hospital' && hospitalId && token) {
        loginSuccess(hospitalId, { hospitalId });
      } else {
        document.getElementById('login-section').style.display = 'flex';
      }
    });

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
    }

    function logout() {
      localStorage.clear();
      window.location.reload();
    }

    async function loginHospital() {
      try {
        const hospitalId = document.getElementById('login-hospitalId').value.trim();
        const password = document.getElementById('login-password').value;
        if (!hospitalId || !password) return alert('Enter ID and Password');

        const res = await login('hospital', hospitalId, password);
        loginSuccess(hospitalId, res);
      } catch (e) {
        const msg = document.getElementById('login-msg');
        msg.innerText = 'Login failed: ' + e.message;
        msg.style.display = 'block';
      }
    }

    function loginSuccess(hospitalId, user) {
      currentHospitalId = hospitalId;
      currentUser = user;

      document.getElementById('login-section').style.display = 'none';
      document.getElementById('dashboard-layout').style.display = 'flex';

      joinHospitalRoom(currentHospitalId);
      setupSocketListeners();

      // Load initial data
      loadDashboardStats();
      showSection('dashboard');
    }

    function showSection(name) {
      document.querySelectorAll('.portal-section').forEach(el => el.style.display = 'none');
      const target = document.getElementById('section-' + name);
      if (target) target.style.display = 'block';

      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      // Add active class logic here if needed

      if (name === 'dashboard') loadDashboardStats();
      if (name === 'hospital-info') loadHospitalInfo();
      if (name === 'beds') loadBeds();
      if (name === 'doctors') loadDoctors();
      if (name === 'ambulances') loadAmbulances();
      if (name === 'emergencies') loadEmergencies();
      if (name === 'dbms') loadDBMS();
    }

    // --- Dashboard Stats ---
    async function loadDashboardStats() {
      if (!currentHospitalId) return;
      try {
        const [beds, doctors, ambulances, emergencies] = await Promise.all([
          api(`/api/beds/${currentHospitalId}`),
          api(`/api/doctors/${currentHospitalId}`),
          api(`/api/ambulances/${currentHospitalId}`),
          api(`/api/emergency/${currentHospitalId}`)
        ]);

        const vacantBeds = beds.filter(b => b.status !== 'Occupied').length;
        const activeDocs = doctors.filter(d => d.availability === 'Available').length;
        const activeAmbs = ambulances.filter(a => a.status === 'On Duty').length;

        document.getElementById('dash-beds').innerText = `${vacantBeds} / ${beds.length}`;
        document.getElementById('dash-docs').innerText = `${activeDocs} / ${doctors.length}`;
        document.getElementById('dash-ambs').innerText = `${activeAmbs} / ${ambulances.length}`;

        // Recent emergencies table
        const recent = emergencies.slice(0, 5);
        const tbody = document.getElementById('dash-recent-emergencies');
        if (recent.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-4">No recent emergencies</td></tr>';
        } else {
          tbody.innerHTML = recent.map(e => `
            <tr>
              <td>${e.patient?.name || 'Unknown'}</td>
              <td>${e.patient?.emergencyType || 'General'}</td>
              <td><span class="badge" style="background: ${getStatusBg(e.status)}; color: ${getStatusColor(e.status)}">${e.status}</span></td>
              <td>${new Date(e.createdAt).toLocaleTimeString()}</td>
            </tr>
          `).join('');
        }
      } catch (e) { console.error(e); }
    }

    function getStatusColor(status) {
      if (status === 'Pending') return '#856404';
      if (status === 'Accepted') return '#0f5132';
      if (status === 'Denied') return '#842029';
      return '#41464b';
    }

    function getStatusBg(status) {
      if (status === 'Pending') return '#fff3cd';
      if (status === 'Accepted') return '#d1e7dd';
      if (status === 'Denied') return '#f8d7da';
      return '#e2e3e5';
    }

    // --- Hospital Info ---
    async function loadHospitalInfo() {
      const h = await api(`/api/hospital/${currentHospitalId}`);
      // Populate fields
      ['id', 'name', 'contact', 'state', 'district', 'city', 'street'].forEach(f => {
        const el = document.getElementById(`h-${f}`);
        if (el) el.value = (f === 'id' ? h.hospitalId : f === 'street' ? h.address?.street : h.address?.[f] || h[f] || '');
      });
      // Arrays
      ['services', 'tests', 'insurance', 'procedures', 'facilities', 'management', 'highlights', 'treatment', 'surgery', 'therapy'].forEach(f => {
        const el = document.getElementById(`h-${f}`);
        if (el) el.value = (h[f] || []).join(', ');
      });

      // QR check
      if (h.attendanceQR?.presentQR) {
        document.getElementById('present-qr-img').src = h.attendanceQR.presentQR;
        document.getElementById('absent-qr-img').src = h.attendanceQR.absentQR;
        document.getElementById('qr-display').style.display = 'block';
        document.getElementById('gen-qr-btn').style.display = 'none';
        document.getElementById('print-qr-btn').style.display = 'inline-block';
      }
    }

    async function saveHospital() {
      const body = {
        name: document.getElementById('h-name').value,
        contact: document.getElementById('h-contact').value,
        address: {
          state: document.getElementById('h-state').value,
          district: document.getElementById('h-district').value,
          city: document.getElementById('h-city').value,
          street: document.getElementById('h-street').value
        },
        services: document.getElementById('h-services').value.split(',').map(s => s.trim()).filter(Boolean)
        // Add other array fields similarly if needed for full update
      };
      try {
        await api(`/api/hospital/${currentHospitalId}`, { method: 'PUT', body: JSON.stringify(body) });
        alert('Saved successfully');
      } catch (e) { alert('Error: ' + e.message); }
    }

    // --- Beds ---
    async function loadBeds() {
      const beds = await api(`/api/beds/${currentHospitalId}`);
      const tbody = document.getElementById('beds');
      tbody.innerHTML = beds.map(b => `
        <tr>
          <td>${b.bedType}</td>
          <td>${b.wardNumber}</td>
          <td>${b.bedNumber}</td>
          <td><span class="badge badge-${b.status === 'Occupied' ? 'danger' : 'success'}">${b.status}</span></td>
          <td>
            <button onclick="toggleBed('${b.bedId}', '${b.status}')" class="btn btn-sm btn-outline">
              ${b.status === 'Occupied' ? 'Free' : 'Occupy'}
            </button>
            <a href="/api/beds/pdf/${b.bedId}" target="_blank" class="btn btn-sm btn-outline">QR</a>
          </td>
        </tr>
      `).join('');

      // Summary
      const total = beds.length;
      const vacant = beds.filter(b => b.status !== 'Occupied').length;
      document.getElementById('bed-summary').innerText = `Total: ${total} | Vacant: ${vacant} | Occupied: ${total - vacant}`;
    }

    async function createBeds() {
      const body = {
        hospitalId: currentHospitalId,
        wardNumber: document.getElementById('ward').value,
        bedType: document.getElementById('bedType').value,
        start: parseInt(document.getElementById('start').value),
        end: parseInt(document.getElementById('end').value)
      };
      try {
        await api('/api/beds', { method: 'POST', body: JSON.stringify(body) });
        loadBeds();
        document.getElementById('beds-status').innerText = 'Beds created!';
      } catch (e) { alert(e.message); }
    }

    async function toggleBed(id, status) {
      const newStatus = status === 'Occupied' ? 'Vacant' : 'Occupied';
      await api(`/api/beds/${id}`, { method: 'PUT', body: JSON.stringify({ status: newStatus }) });
      loadBeds();
    }

    // --- Doctors ---
    async function loadDoctors() {
      const docs = await api(`/api/doctors/${currentHospitalId}`);
      const container = document.getElementById('doctors-list');
      container.innerHTML = docs.map(d => `
        <div class="card flex flex-row gap-md items-center p-3">
          <div style="width:50px;height:50px;background:#eee;border-radius:50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">üë®‚Äç‚öïÔ∏è</div>
          <div style="flex:1;">
            <div class="font-bold">${d.name}</div>
            <div class="text-muted text-sm">${d.speciality}</div>
            <div class="text-sm mt-1">
              <span class="badge badge-${d.availability === 'Available' ? 'success' : 'secondary'}">${d.availability}</span>
            </div>
          </div>
        </div>
      `).join('');
    }

    async function createDoctor() {
      const body = {
        hospitalId: currentHospitalId,
        doctorId: document.getElementById('doc-id').value,
        name: document.getElementById('doc-name').value,
        speciality: document.getElementById('doc-spec').value,
        qualification: document.getElementById('doc-qual').value,
        experience: document.getElementById('doc-exp').value,
        photoUrl: document.getElementById('doc-photo').value
      };
      try {
        await api('/api/doctors', { method: 'POST', body: JSON.stringify(body) });
        loadDoctors();
        alert('Doctor registered');
      } catch (e) { alert(e.message); }
    }

    async function generateHospitalQR() {
      try {
        const res = await api(`/api/hospital/${currentHospitalId}/attendance-qr`, { method: 'POST' });
        loadHospitalInfo(); // Refresh to show QR
      } catch (e) { alert(e.message); }
    }
  </script>
</body>

</html>